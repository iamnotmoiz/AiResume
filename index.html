<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResumeAutopilot | AI Portfolio Architect</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF.js for Client-Side Text Extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .preview-frame { width: 100%; height: 100%; border: none; background: white; }
        /* Scrollbar hiding for clean UI */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden selection:bg-indigo-100 selection:text-indigo-700">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon Component ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        // --- Main Application ---
        const App = () => {
            // -- State --
            const [step, setStep] = useState(1); // 1: Input, 2: Generating, 3: Preview, 4: Deploying, 5: Success
            
            // Input Data
            const [resumeFile, setResumeFile] = useState(null);
            const [resumeText, setResumeText] = useState('');
            const [jobLink, setJobLink] = useState('');
            const [selectedTheme, setSelectedTheme] = useState('Minimalist');
            const [githubToken, setGithubToken] = useState(() => localStorage.getItem('rt_gh_token') || '');
            
            // Process Data
            const [generatedHtml, setGeneratedHtml] = useState('');
            const [statusMessage, setStatusMessage] = useState('');
            const [error, setError] = useState('');
            const [liveUrl, setLiveUrl] = useState('');
            
            // Persist Token
            useEffect(() => { localStorage.setItem('rt_gh_token', githubToken); }, [githubToken]);

            // --- PDF Extraction Logic ---
            const extractTextFromPDF = async (file) => {
                setStatusMessage("Reading your resume...");
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = "";
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n";
                    }
                    setResumeText(fullText);
                    setResumeFile(file);
                    return fullText;
                } catch (err) {
                    setError("Failed to read PDF. Please ensure it is a valid text-based PDF.");
                    console.error(err);
                    return null;
                }
            };

            const handleFileSelect = async (e) => {
                const file = e.target.files[0];
                if (file) await extractTextFromPDF(file);
            };

            // --- AI Generation Logic ---
            const generateWebsite = async () => {
                if (!resumeText || !jobLink) {
                    setError("Please upload a resume and provide a job link.");
                    return;
                }

                setStep(2); // Generating
                setError('');
                setStatusMessage("Analyzing your career history...");

                const apiKey = ""; // API Key injected by environment
                
                const prompts = {
                    'Minimalist': 'Clean, Apple-esque, ample whitespace, Inter font, subtle gray/slate colors.',
                    'Professional': 'Corporate, blue/navy accents, serif headings, structured grid layout.',
                    'Creative': 'Bold typography, vibrant gradients, dark mode default, modern cards.'
                };

                const systemPrompt = `
                    You are an expert Senior Frontend Engineer and Career Coach.
                    Your task is to generate a single-file, responsive, beautiful HTML/Tailwind CSS personal website.
                    
                    CRITICAL RULES:
                    1. SOURCE TRUTH: You must ONLY use the information provided in the [RESUME TEXT]. DO NOT invent jobs, degrees, or skills not present in the text.
                    2. TAILORING: You must analyze the [TARGET JOB] and re-order/highlight the user's existing skills/experience to match that job description.
                    3. CODE: Return ONLY raw HTML code. No markdown backticks.
                    4. TECH STACK: Use Tailwind CSS via CDN. Use Google Fonts.
                    5. UX: The site must be mobile-responsive.
                    6. IMAGERY: Use clear placeholders like 'https://placehold.co/100x100' for the profile picture if none exists.
                    
                    DESIGN THEME: ${prompts[selectedTheme]}
                `;

                const userMessage = `
                    [RESUME TEXT]:
                    ${resumeText.substring(0, 8000)} 

                    [TARGET JOB LINK/DESC]:
                    ${jobLink}

                    Create the HTML file now.
                `;

                try {
                    setStatusMessage("Architecting layout...");
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userMessage }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            tools: [{ "google_search": {} }] // Enable search to understand the Job Link context
                        })
                    });

                    setStatusMessage("Writing code...");
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);
                    
                    let html = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    // Cleanup markdown if AI adds it despite instructions
                    html = html.replace(/```html/g, '').replace(/```/g, '').trim();
                    
                    setGeneratedHtml(html);
                    setStep(3); // Preview
                } catch (err) {
                    setError("Generation failed: " + err.message);
                    setStep(1);
                }
            };

            // --- Deployment Logic ---
            const deployToGitHub = async () => {
                if (!githubToken) {
                    setError("GitHub Token required for deployment.");
                    return;
                }

                setStep(4); // Deploying
                setStatusMessage("Initializing repository...");

                const repoName = `portfolio-${Date.now()}`;
                const headers = {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                };

                try {
                    // 1. Create Repo
                    const repoRes = await fetch('https://api.github.com/user/repos', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ name: repoName, auto_init: true, description: "Generated via ResumeAutopilot" })
                    });
                    const repoData = await repoRes.json();
                    if (!repoRes.ok) throw new Error(repoData.message);

                    setStatusMessage("Uploading tailored website...");

                    // 2. Upload Index.html
                    await fetch(`https://api.github.com/repos/${repoData.full_name}/contents/index.html`, {
                        method: 'PUT',
                        headers,
                        body: JSON.stringify({
                            message: "Deploy tailored resume",
                            content: btoa(unescape(encodeURIComponent(generatedHtml)))
                        })
                    });

                    setStatusMessage("Configuring GitHub Pages...");

                    // 3. Enable Pages
                    await fetch(`https://api.github.com/repos/${repoData.full_name}/pages`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ source: { branch: 'main' } })
                    });

                    // Success
                    setLiveUrl(`https://${repoData.owner.login}.github.io/${repoName}/`);
                    setStep(5);

                } catch (err) {
                    setError("Deployment failed: " + err.message);
                    setStep(3); // Go back to preview
                }
            };

            // --- Render Steps ---

            const renderInput = () => (
                <div className="max-w-4xl mx-auto pt-10 px-6 animate-slide-up">
                    <header className="text-center mb-12">
                        <div className="inline-flex items-center justify-center p-3 bg-indigo-100 rounded-2xl mb-4 text-indigo-600">
                            <Icon name="sparkles" size={32} />
                        </div>
                        <h1 className="text-4xl md:text-6xl font-black tracking-tight text-slate-900 mb-4">
                            Resume<span className="text-indigo-600">Autopilot</span>
                        </h1>
                        <p className="text-lg text-slate-500 font-medium max-w-xl mx-auto">
                            Transform your PDF resume into a tailored personal website based on any job description.
                        </p>
                    </header>

                    <div className="grid md:grid-cols-2 gap-6">
                        {/* Left: Resume Upload */}
                        <div className="bg-white p-8 rounded-3xl shadow-xl shadow-slate-200 border border-slate-100 flex flex-col items-center text-center hover:border-indigo-200 transition-colors">
                            <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-4 ${resumeFile ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}`}>
                                <Icon name={resumeFile ? "check" : "file-text"} size={32} />
                            </div>
                            <h3 className="font-bold text-lg mb-2">{resumeFile ? resumeFile.name : "Upload Resume (PDF)"}</h3>
                            <p className="text-sm text-slate-400 mb-6">We extract the text locally to ensure privacy.</p>
                            
                            <label className="cursor-pointer bg-slate-900 text-white px-6 py-3 rounded-xl font-semibold hover:bg-slate-800 transition-transform active:scale-95">
                                <span>{resumeFile ? "Change File" : "Select PDF"}</span>
                                <input type="file" className="hidden" accept=".pdf" onChange={handleFileSelect} />
                            </label>
                            {resumeText && <span className="mt-4 text-xs text-green-600 font-bold flex items-center gap-1"><Icon name="scan-face" size={12}/> {resumeText.length} chars extracted</span>}
                        </div>

                        {/* Right: Job & Style */}
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                                <label className="block text-xs font-bold uppercase text-slate-400 mb-2">Target Job</label>
                                <div className="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-200 focus-within:ring-2 ring-indigo-500 focus-within:border-transparent transition-all">
                                    <Icon name="briefcase" className="text-slate-400" />
                                    <input 
                                        type="text" 
                                        className="bg-transparent w-full outline-none font-medium text-slate-800"
                                        placeholder="Paste Job URL or Description..."
                                        value={jobLink}
                                        onChange={(e) => setJobLink(e.target.value)}
                                    />
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                                <label className="block text-xs font-bold uppercase text-slate-400 mb-3">Design Theme</label>
                                <div className="flex gap-2">
                                    {['Minimalist', 'Professional', 'Creative'].map(theme => (
                                        <button 
                                            key={theme}
                                            onClick={() => setSelectedTheme(theme)}
                                            className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all border ${selectedTheme === theme ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}
                                        >
                                            {theme}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <button 
                                onClick={generateWebsite}
                                disabled={!resumeText || !jobLink}
                                className="w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white p-4 rounded-2xl font-bold text-lg shadow-xl shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-2xl hover:scale-[1.02] transition-all flex items-center justify-center gap-2"
                            >
                                <Icon name="wand-2" /> Generate Website
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderLoading = () => (
                <div className="flex flex-col items-center justify-center h-screen animate-fade-in">
                    <div className="relative w-24 h-24 mb-8">
                        <div className="absolute inset-0 border-4 border-slate-200 rounded-full"></div>
                        <div className="absolute inset-0 border-4 border-t-indigo-600 rounded-full animate-spin"></div>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <Icon name="cpu" className="text-indigo-600" />
                        </div>
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">Building your site...</h2>
                    <p className="text-slate-500 animate-pulse">{statusMessage}</p>
                </div>
            );

            const renderPreview = () => (
                <div className="h-screen flex flex-col animate-fade-in bg-slate-100">
                    {/* Toolbar */}
                    <div className="bg-white h-16 border-b flex items-center justify-between px-6 shadow-sm z-10">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setStep(1)} className="text-slate-500 hover:text-slate-800 flex items-center gap-2 text-sm font-semibold">
                                <Icon name="arrow-left" size={16}/> Back
                            </button>
                            <div className="h-6 w-px bg-slate-200"></div>
                            <span className="text-sm font-bold text-slate-600 flex items-center gap-2">
                                <Icon name="eye" size={16} className="text-indigo-600"/> Live Preview
                            </span>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            <div className="hidden md:flex items-center gap-2 mr-4">
                                <input 
                                    type="password" 
                                    placeholder="GitHub Token (ghp_...)" 
                                    value={githubToken}
                                    onChange={(e) => setGithubToken(e.target.value)}
                                    className="bg-slate-100 border border-slate-200 rounded-lg px-3 py-1.5 text-xs w-48 focus:ring-2 ring-indigo-500 outline-none"
                                />
                                <a href="https://github.com/settings/tokens/new?scopes=repo,workflow" target="_blank" className="text-xs text-indigo-500 hover:underline">Get Token</a>
                            </div>
                            <button onClick={deployToGitHub} className="bg-slate-900 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 flex items-center gap-2 transition-transform active:scale-95">
                                <Icon name="rocket" size={16} /> Deploy Live
                            </button>
                        </div>
                    </div>

                    {/* Iframe Preview */}
                    <div className="flex-1 p-4 md:p-8 flex justify-center">
                        <div className="w-full max-w-6xl bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-200 ring-4 ring-slate-200/50">
                            <iframe 
                                srcDoc={generatedHtml} 
                                className="preview-frame" 
                                title="Website Preview"
                                sandbox="allow-scripts allow-same-origin"
                            />
                        </div>
                    </div>
                </div>
            );

            const renderSuccess = () => (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-50 animate-fade-in relative overflow-hidden">
                    {/* Background decoration */}
                    <div className="absolute top-0 left-0 w-full h-full opacity-5 pointer-events-none">
                        <div className="absolute top-10 left-10 w-64 h-64 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl animate-blob"></div>
                        <div className="absolute top-10 right-10 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl animate-blob animation-delay-2000"></div>
                    </div>

                    <div className="glass-panel p-12 rounded-[2.5rem] text-center max-w-lg shadow-2xl relative z-10">
                        <div className="w-20 h-20 bg-green-500 text-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-green-200">
                            <Icon name="check" size={40} strokeWidth={3} />
                        </div>
                        <h2 className="text-3xl font-black text-slate-800 mb-4">You're Live!</h2>
                        <p className="text-slate-500 mb-8">Your tailored website has been deployed to GitHub Pages and will be globally accessible in ~60 seconds.</p>
                        
                        <div className="bg-white p-4 rounded-xl border border-slate-200 mb-8 flex items-center gap-3">
                            <Icon name="globe" className="text-slate-400 shrink-0" />
                            <input readOnly value={liveUrl} className="w-full bg-transparent text-sm font-mono text-slate-600 outline-none" />
                            <a href={liveUrl} target="_blank" className="p-2 hover:bg-slate-100 rounded-lg text-indigo-600 transition-colors">
                                <Icon name="external-link" size={18} />
                            </a>
                        </div>

                        <div className="flex gap-4">
                            <button onClick={() => setStep(1)} className="flex-1 py-3 rounded-xl border border-slate-300 font-bold text-slate-600 hover:bg-slate-50 transition-colors">
                                Build Another
                            </button>
                            <a href={liveUrl} target="_blank" className="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-colors">
                                Visit Site
                            </a>
                        </div>
                    </div>
                </div>
            );

            // --- Error Overlay ---
            return (
                <div className="min-h-screen bg-slate-50">
                    {error && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 z-50 animate-slide-up">
                            <Icon name="alert-circle" size={20} />
                            <span className="font-medium text-sm">{error}</span>
                            <button onClick={() => setError('')} className="ml-2 opacity-80 hover:opacity-100"><Icon name="x" size={16}/></button>
                        </div>
                    )}

                    {step === 1 && renderInput()}
                    {step === 2 && renderLoading()}
                    {step === 3 && renderPreview()}
                    {step === 4 && renderLoading()} {/* Reuse loading for deploying */}
                    {step === 5 && renderSuccess()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>